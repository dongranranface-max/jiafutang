<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è—å“ç®¡ç† - å˜‰å­šå ‚åå°</title>
    <link rel="stylesheet" href="../../css/style.css">
    <style>
        * { box-sizing: border-box; }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f7fa; }
        .admin-wrapper { display: flex; min-height: 100vh; }
        
        /* ä¾§è¾¹æ  */
        .sidebar { width: 240px; background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%); color: #fff; padding: 0; position: fixed; height: 100vh; }
        .sidebar-header { padding: 30px 20px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .sidebar-header img { width: 60px; margin-bottom: 10px; }
        .sidebar-header h2 { margin: 0; font-size: 18px; }
        .sidebar-nav { padding: 20px 0; }
        .nav-item { display: flex; align-items: center; padding: 15px 25px; color: rgba(255,255,255,0.7); text-decoration: none; transition: all 0.3s; }
        .nav-item:hover, .nav-item.active { background: rgba(255,255,255,0.1); color: #fff; border-left: 3px solid #c9a962; }
        .nav-item span:first-child { margin-right: 10px; font-size: 18px; }
        
        /* ä¸»å†…å®¹ */
        .main-content { flex: 1; margin-left: 240px; padding: 30px; }
        
        /* é¡µé¢å¤´éƒ¨ */
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .page-header h1 { margin: 0; font-size: 28px; color: #1a1a2e; }
        
        /* æŒ‰é’® */
        .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; transition: all 0.3s; }
        .btn-primary { background: linear-gradient(135deg, #c9a962 0%, #a88b4c 100%); color: #fff; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(201,169,98,0.4); }
        .btn-danger { background: #ff4757; color: #fff; }
        .btn-danger:hover { background: #ff6b81; }
        .btn-sm { padding: 8px 16px; font-size: 13px; }
        
        /* æœç´¢æ  */
        .filter-bar { background: #fff; padding: 20px; border-radius: 10px; margin-bottom: 20px; display: flex; gap: 15px; flex-wrap: wrap; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .filter-bar select, .filter-bar input { padding: 10px 15px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 14px; min-width: 150px; }
        .filter-bar input { flex: 1; min-width: 200px; }
        
        /* è¡¨æ ¼ */
        .table-wrapper { background: #fff; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th { background: #f8f9fa; padding: 15px; text-align: left; font-weight: 600; color: #555; font-size: 13px; text-transform: uppercase; }
        .data-table td { padding: 15px; border-bottom: 1px solid #f0f0f0; font-size: 14px; }
        .data-table tr:hover { background: #fafafa; }
        .data-table .checkbox { width: 40px; }
        
        /* çŠ¶æ€æ ‡ç­¾ */
        .status-tag { padding: 4px 10px; border-radius: 20px; font-size: 12px; }
        .status-tag.sold { background: #e8f5e9; color: #2e7d32; }
        .status-tag.unsold { background: #fff3e0; color: #ef6c00; }
        .status-tag.coming { background: #e3f2fd; color: #1565c0; }
        .status-tag.yes { background: #e8f5e9; color: #2e7d32; }
        .status-tag.no { background: #ffebee, color: #c62828; }
        
        /* æ“ä½œæŒ‰é’® */
        .action-btns { display: flex; gap: 8px; }
        .action-btn { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; }
        .edit-btn { background: #e3f2fd; color: #1976d2; }
        .edit-btn:hover { background: #bbdefb; }
        .delete-btn { background: #ffebee; color: #c62828; }
        .delete-btn:hover { background: #ffcdd2; }
        
        /* æ‰¹é‡æ“ä½œ */
        .batch-actions { display: none; padding: 15px 20px; background: #fff3e0; border-radius: 8px; margin-bottom: 15px; align-items: center; gap: 15px; }
        .batch-actions.show { display: flex; }
        
        /* åˆ†é¡µ */
        .pagination { display: flex; justify-content: center; gap: 8px; margin-top: 20px; }
        .page-btn { padding: 8px 14px; border: 1px solid #ddd; background: #fff; border-radius: 4px; cursor: pointer; }
        .page-btn.active { background: #c9a962; color: #fff; border-color: #c9a962; }
        
        /* å¼¹çª— */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-overlay.active { display: flex; }
        .modal { background: #fff; border-radius: 12px; width: 90%; max-width: 600px; max-height: 90vh; overflow: auto; }
        .modal-header { padding: 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h3 { margin: 0; font-size: 18px; }
        .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: #999; }
        .modal-body { padding: 20px; }
        
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: #333; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .form-actions { display: flex; gap: 10px; justify-content: flex-end; padding-top: 20px; }
        
        .empty-state { text-align: center; padding: 60px; color: #999; }
        
        /* å›¾ç‰‡é¢„è§ˆ */
        .image-preview { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
        .image-preview-item { position: relative; width: 80px; height: 80px; }
        .image-preview-item img { width: 100%; height: 100%; object-fit: cover; border-radius: 4px; }
        .remove-btn { position: absolute; top: -5px; right: -5px; width: 20px; height: 20px; background: #ff4757; color: #fff; border-radius: 50%; border: none; cursor: pointer; font-size: 12px; line-height: 1; }
    </style>
</head>
<body>
    <div class="admin-wrapper">
        <aside class="sidebar">
            <div class="sidebar-header">
                <img src="../../images/logo.png" alt="å˜‰å­šå ‚">
                <h2>åå°ç®¡ç†</h2>
            </div>
            <nav class="sidebar-nav">
                <a href="../dashboard.html" class="nav-item"><span>ğŸ“Š</span><span>æ§åˆ¶å°</span></a>
                <a href="collections.html" class="nav-item active"><span>ğŸ¨</span><span>è—å“ç®¡ç†</span></a>
                <a href="news.html" class="nav-item"><span>ğŸ“°</span><span>æ–°é—»ç®¡ç†</span></a>
                <a href="submissions.html" class="nav-item"><span>ğŸ“‹</span><span>æäº¤è®°å½•</span></a>
                <a href="#" onclick="logout()" class="nav-item"><span>ğŸšª</span><span>é€€å‡ºç™»å½•</span></a>
            </nav>
        </aside>

        <main class="main-content">
            <div class="page-header">
                <h1>ğŸ¨ è—å“ç®¡ç†</h1>
                <button class="btn btn-primary" onclick="openModal()">+ æ·»åŠ è—å“</button>
            </div>

            <!-- æ‰¹é‡æ“ä½œæ  -->
            <div class="batch-actions" id="batchActions">
                <span>å·²é€‰æ‹© <strong id="selectedCount">0</strong> é¡¹</span>
                <button class="btn btn-danger btn-sm" onclick="batchDelete()">æ‰¹é‡åˆ é™¤</button>
                <button class="btn btn-sm" onclick="clearSelection()">å–æ¶ˆé€‰æ‹©</button>
            </div>

            <!-- æœç´¢ç­›é€‰ -->
            <div class="filter-bar">
                <select id="filterCategory" onchange="renderTable()">
                    <option value="">å…¨éƒ¨åˆ†ç±»</option>
                    <option value="art">è‰ºæœ¯å“</option>
                    <option value="antique">å¤è‘£æ–‡ç‰©</option>
                    <option value="jewelry">ç å®å¥¢ä¾ˆå“</option>
                    <option value="coin">æ–‡çŒ®é‚®å¸</option>
                    <option value="nft">æ•°å­—è—å“</option>
                    <option value="misc">æ‚é¡¹</option>
                </select>
                <select id="filterStatus" onchange="renderTable()">
                    <option value="">å…¨éƒ¨çŠ¶æ€</option>
                    <option value="unsold">æœªæ‹å–</option>
                    <option value="sold">å·²æ‹å–</option>
                    <option value="coming">å³å°†æ‹å–</option>
                </select>
                <input type="text" id="searchKeyword" placeholder="ğŸ” æœç´¢è—å“åç§°..." oninput="renderTable()">
            </div>

            <!-- æ•°æ®è¡¨æ ¼ -->
            <div class="table-wrapper">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th class="checkbox"><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                            <th>ç¼–å·</th>
                            <th>åç§°</th>
                            <th>åˆ†ç±»</th>
                            <th>çŠ¶æ€</th>
                            <th>æ¨è</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="collectionsTable">
                    </tbody>
                </table>
            </div>

            <div class="pagination" id="pagination"></div>
        </main>
    </div>

    <!-- å¼¹çª— -->
    <div class="modal-overlay" id="collectionModal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modalTitle">æ·»åŠ è—å“</h3>
                <button class="modal-close" onclick="closeModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <form id="collectionForm">
                    <input type="hidden" id="collectionId">
                    <div class="form-row">
                        <div class="form-group">
                            <label>è—å“åç§° *</label>
                            <input type="text" id="itemTitle" required placeholder="è¯·è¾“å…¥è—å“åç§°">
                        </div>
                        <div class="form-group">
                            <label>å“ç±» *</label>
                            <select id="itemCategory" required>
                                <option value="">è¯·é€‰æ‹©</option>
                                <option value="art">è‰ºæœ¯å“</option>
                                <option value="antique">å¤è‘£æ–‡ç‰©</option>
                                <option value="jewelry">ç å®å¥¢ä¾ˆå“</option>
                                <option value="coin">æ–‡çŒ®é‚®å¸</option>
                                <option value="nft">æ•°å­—è—å“</option>
                                <option value="misc">æ‚é¡¹</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>çŠ¶æ€ *</label>
                            <select id="itemStatus" required>
                                <option value="unsold">æœªæ‹å–</option>
                                <option value="sold">å·²æ‹å–</option>
                                <option value="coming">å³å°†æ‹å–</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>é¦–é¡µæ¨è</label>
                            <select id="itemFeatured">
                                <option value="false">å¦</option>
                                <option value="true">æ˜¯</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>å°é¢å›¾ç‰‡ï¼ˆä¸Šä¼ æˆ–è¾“å…¥URLï¼‰</label>
                        <input type="file" id="itemImageFile" accept="image/*" onchange="previewImage(this)">
                        <div id="imagePreview" style="margin-top:10px;display:none;">
                            <img id="previewImg" style="max-width:200px;border-radius:4px;">
                        </div>
                        <input type="text" id="itemCoverImage" placeholder="å›¾ç‰‡URLï¼Œä¹Ÿå¯æ‰‹åŠ¨è¾“å…¥" style="margin-top:10px;">
                    </div>
                    <div class="form-group">
                        <label>ç®€ä»‹</label>
                        <textarea id="itemSummary" rows="2" placeholder="ç®€çŸ­æè¿°..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>è¯¦ç»†ä»‹ç»</label>
                        <textarea id="itemContent" rows="6" placeholder="è¯¦ç»†ä»‹ç»å†…å®¹..."></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn" onclick="closeModal()">å–æ¶ˆ</button>
                        <button type="button" class="btn btn-primary" onclick="saveCollection()">ä¿å­˜</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
    const API_URL = 'https://jiafutang-api.dongranranface.workers.dev';
    const CLOUDINARY_CLOUD = 'dongranranface';
    let collections = [];
    let currentPage = 1;
    const pageSize = 10;
    let selectedIds = [];

    // åˆå§‹åŒ–
    function init() {
        loadCollections();
    }

    // åŠ è½½æ•°æ®
    function loadCollections() {
        fetch(API_URL + '/api/collections')
            .then(res => res.json())
            .then(data => {
                collections = data || [];
                renderTable();
            });
    }

    // æ¸²æŸ“è¡¨æ ¼
    function renderTable() {
        const category = document.getElementById('filterCategory').value;
        const status = document.getElementById('filterStatus').value;
        const keyword = document.getElementById('searchKeyword').value.toLowerCase();
        
        let filtered = collections.filter(c => {
            if (category && c.category !== category) return false;
            if (status && c.status !== status) return false;
            if (keyword && !c.title.toLowerCase().includes(keyword)) return false;
            return true;
        });
        
        filtered.sort((a,b) => b.sort - a.sort);
        
        const totalPages = Math.ceil(filtered.length / pageSize);
        const start = (currentPage - 1) * pageSize;
        const paged = filtered.slice(start, start + pageSize);
        
        const categoryMap = {art:'è‰ºæœ¯å“',antique:'å¤è‘£æ–‡ç‰©',jewelry:'ç å®å¥¢ä¾ˆå“',coin:'æ–‡çŒ®é‚®å¸',nft:'æ•°å­—è—å“',misc:'æ‚é¡¹'};
        const statusMap = {sold:'å·²æ‹å–',unsold:'æœªæ‹å–',coming:'å³å°†æ‹å–'};
        
        const tbody = document.getElementById('collectionsTable');
        if (paged.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="empty-state">æš‚æ— æ•°æ®</td></tr>';
        } else {
            tbody.innerHTML = paged.map(c => {
                const isSelected = selectedIds.includes(c.id);
                return '<tr>' +
                    '<td class="checkbox"><input type="checkbox" ' + (isSelected ? 'checked' : '') + ' onchange="toggleSelect(' + c.id + ')"></td>' +
                    '<td>' + c.id + '</td>' +
                    '<td><strong>' + c.title + '</strong></td>' +
                    '<td><span class="status-tag">' + (categoryMap[c.category] || c.category) + '</span></td>' +
                    '<td><span class="status-tag ' + c.status + '">' + statusMap[c.status] + '</span></td>' +
                    '<td><span class="status-tag ' + (c.is_featured ? 'yes' : 'no') + '">' + (c.is_featured ? 'âœ“' : 'âœ—') + '</span></td>' +
                    '<td><div class="action-btns">' +
                    '<button class="action-btn edit-btn" onclick="editCollection(' + c.id + ')">ç¼–è¾‘</button>' +
                    '<button class="action-btn delete-btn" onclick="deleteCollection(' + c.id + ')">åˆ é™¤</button></div></td>' +
                '</tr>';
            }).join('');
        }
        
        // æ›´æ–°æ‰¹é‡æ“ä½œæ 
        updateBatchActions();
        
        // æ¸²æŸ“åˆ†é¡µ
        renderPagination(totalPages);
    }

    // åˆ†é¡µ
    function renderPagination(totalPages) {
        if (totalPages <= 1) {
            document.getElementById('pagination').innerHTML = '';
            return;
        }
        let html = '';
        for (let i = 1; i <= totalPages; i++) {
            html += '<button class="page-btn' + (i === currentPage ? ' active' : '') + '" onclick="goPage(' + i + ')">' + i + '</button>';
        }
        document.getElementById('pagination').innerHTML = html;
    }

    function goPage(page) {
        currentPage = page;
        renderTable();
    }

    // å…¨é€‰
    function toggleSelectAll() {
        const checked = document.getElementById('selectAll').checked;
        if (checked) {
            selectedIds = collections.map(c => c.id);
        } else {
            selectedIds = [];
        }
        renderTable();
    }

    function toggleSelect(id) {
        if (selectedIds.includes(id)) {
            selectedIds = selectedIds.filter(i => i !== id);
        } else {
            selectedIds.push(id);
        }
        renderTable();
    }

    function updateBatchActions() {
        const el = document.getElementById('batchActions');
        document.getElementById('selectedCount').textContent = selectedIds.length;
        el.classList.toggle('show', selectedIds.length > 0);
    }

    function clearSelection() {
        selectedIds = [];
        renderTable();
    }

    // æ‰¹é‡åˆ é™¤
    function batchDelete() {
        if (!confirm('ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ' + selectedIds.length + ' æ¡è—å“å—ï¼Ÿ')) return;
        Promise.all(selectedIds.map(id => 
            fetch(API_URL + '/api/collections/' + id, {method:'DELETE'}).then(r=>r.json())
        )).then(() => {
            selectedIds = [];
            loadCollections();
            alert('æ‰¹é‡åˆ é™¤æˆåŠŸï¼');
        });
    }

    // å¼¹çª—
    function openModal(id) {
        document.getElementById('collectionModal').classList.add('active');
        document.getElementById('modalTitle').textContent = id ? 'ç¼–è¾‘è—å“' : 'æ·»åŠ è—å“';
        document.getElementById('collectionId').value = id || '';
        document.getElementById('collectionForm').reset();
        document.getElementById('imagePreview').style.display = 'none';
        
        if (id) {
            const c = collections.find(x => x.id === id);
            if (c) {
                document.getElementById('itemTitle').value = c.title || '';
                document.getElementById('itemCategory').value = c.category || '';
                document.getElementById('itemStatus').value = c.status || '';
                document.getElementById('itemFeatured').value = c.is_featured ? 'true' : 'false';
                document.getElementById('itemCoverImage').value = c.cover_image || '';
                document.getElementById('itemSummary').value = c.summary || '';
                document.getElementById('itemContent').value = c.content || '';
                // æ˜¾ç¤ºå›¾ç‰‡é¢„è§ˆ
                if (c.cover_image) {
                    document.getElementById('previewImg').src = c.cover_image;
                    document.getElementById('imagePreview').style.display = 'block';
                }
            }
        }
    }

    // å›¾ç‰‡é¢„è§ˆ
    function previewImage(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('previewImg').src = e.target.result;
                document.getElementById('imagePreview').style.display = 'block';
                // åŒæ—¶è®¾ç½®URLè¾“å…¥æ¡†
                document.getElementById('itemCoverImage').value = e.target.result;
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    // ä¸Šä¼ å›¾ç‰‡åˆ°Cloudinary
    async function uploadImage(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const formData = new FormData();
                    formData.append('file', e.target.result);
                    formData.append('upload_preset', 'ml_default');
                    
                    const res = await fetch('https://api.cloudinary.com/v1_1/dongranranface/image/upload', {
                        method: 'POST',
                        body: formData
                    });
                    const data = await res.json();
                    if (data.secure_url) {
                        resolve(data.secure_url);
                    } else {
                        reject(new Error('Upload failed'));
                    }
                } catch(err) {
                    reject(err);
                }
            };
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }

    function closeModal() {
        document.getElementById('collectionModal').classList.remove('active');
    }

    function editCollection(id) {
        openModal(id);
    }

    // ä¿å­˜
    async function saveCollection() {
        const id = document.getElementById('collectionId').value;
        const fileInput = document.getElementById('itemImageFile');
        let coverImage = document.getElementById('itemCoverImage').value;
        
        // å¦‚æœé€‰æ‹©äº†æ–°æ–‡ä»¶ï¼Œå…ˆä¸Šä¼ 
        if (fileInput.files && fileInput.files[0]) {
            try {
                coverImage = await uploadImage(fileInput.files[0]);
            } catch(e) {
                alert('å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼Œå°†ä½¿ç”¨è¾“å…¥çš„URL');
            }
        }
        
        const data = {
            title: document.getElementById('itemTitle').value,
            category: document.getElementById('itemCategory').value,
            status: document.getElementById('itemStatus').value,
            is_featured: document.getElementById('itemFeatured').value === 'true',
            cover_image: coverImage || 'https://images.unsplash.com/photo-1578926288207-a90a5366759d?w=400',
            summary: document.getElementById('itemSummary').value,
            content: document.getElementById('itemContent').value,
            sort: id ? parseInt(id) : (collections.length + 1)
        };
        
        if (!data.title || !data.category) {
            alert('è¯·å¡«å†™å¿…å¡«é¡¹');
            return;
        }
        
        const method = id ? 'PUT' : 'POST';
        const url = id ? API_URL + '/api/collections/' + id : API_URL + '/api/collections';
        
        fetch(url, {
            method: method,
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(data)
        }).then(res => res.json()).then(result => {
            closeModal();
            loadCollections();
            alert('ä¿å­˜æˆåŠŸï¼');
        });
    }

    // åˆ é™¤
    function deleteCollection(id) {
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä»¶è—å“å—ï¼Ÿ')) return;
        fetch(API_URL + '/api/collections/' + id, {method:'DELETE'})
            .then(res => res.json()).then(result => {
                loadCollections();
                alert('åˆ é™¤æˆåŠŸï¼');
            });
    }

    function logout() {
        window.location.href = '../index.html';
    }

    init();
    </script>
</body>
</html>
