<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æäº¤è®°å½• - å˜‰å­šå ‚åå°ç®¡ç†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="../../css/style.css">
    <link rel="stylesheet" href="../css/admin.css">
</head>
<body>
    <div class="admin-wrapper">
        <!-- ä¾§è¾¹æ  -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <img src="../../images/logo.png" alt="å˜‰å­šå ‚">
                <h2>åå°ç®¡ç†</h2>
            </div>
            <nav class="sidebar-nav">
                <a href="../dashboard.html" class="nav-item">
                    <span>ğŸ“Š</span> <span>æ§åˆ¶å°</span>
                </a>
                <a href="collections.html" class="nav-item">
                    <span>ğŸ¨</span> <span>è—å“ç®¡ç†</span>
                </a>
                <a href="news.html" class="nav-item">
                    <span>ğŸ“°</span> <span>æ–°é—»ç®¡ç†</span>
                </a>
                <a href="submissions.html" class="nav-item active">
                    <span>ğŸ“‹</span> <span>æäº¤è®°å½•</span>
                </a>
                <a href="#" onclick="logout(); return false;" class="nav-item">
                    <span>ğŸšª</span> <span>é€€å‡ºç™»å½•</span>
                </a>
            </nav>
        </aside>

        <!-- ä¸»å†…å®¹ -->
        <main class="main-content">
            <div class="page-header">
                <h1>æäº¤è®°å½•</h1>
                <button class="btn-sm btn-view" onclick="exportData()">å¯¼å‡ºæ•°æ®</button>
            </div>

            <!-- ç»Ÿè®¡ -->
            <div class="stats-grid" style="grid-template-columns: repeat(3, 1fr); margin-bottom: 24px;">
                <div class="stat-card">
                    <h3>æ€»æäº¤æ•°</h3>
                    <div class="number" id="totalCount">0</div>
                </div>
                <div class="stat-card">
                    <h3>ä»Šæ—¥æ–°å¢</h3>
                    <div class="number" id="todayCount">0</div>
                </div>
                <div class="stat-card">
                    <h3>å¾…å¤„ç†</h3>
                    <div class="number" id="pendingCount">0</div>
                </div>
            </div>

            <!-- åˆ—è¡¨ -->
            <div class="data-table-container">
                <div class="table-toolbar">
                    <div class="search-box">
                        <select id="filterCategory">
                            <option value="">å…¨éƒ¨åˆ†ç±»</option>
                            <option value="art">è‰ºæœ¯å“</option>
                            <option value="antique">å¤è‘£æ–‡ç‰©</option>
                            <option value="jewelry">ç å®å¥¢ä¾ˆå“</option>
                            <option value="coin">æ–‡çŒ®é‚®å¸</option>
                            <option value="nft">æ•°å­—è—å“</option>
                            <option value="misc">æ‚é¡¹</option>
                        </select>
                        <input type="text" id="searchKeyword" placeholder="æœç´¢è—å“åç§°/è”ç³»äºº...">
                        <button onclick="loadSubmissions()">æœç´¢</button>
                    </div>
                </div>

                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>è—å“åç§°</th>
                            <th>å“ç±»</th>
                            <th>è”ç³»äºº</th>
                            <th>è”ç³»æ–¹å¼</th>
                            <th>åŸå¸‚</th>
                            <th>æäº¤æ—¶é—´</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="submissionsTable">
                        <!-- æ•°æ®å°†é€šè¿‡JSåŠ è½½ -->
                    </tbody>
                </table>

                <div class="pagination" id="pagination"></div>
            </div>
        </main>
    </div>

    <!-- è¯¦æƒ…å¼¹çª— -->
    <div class="modal-overlay" id="detailModal">
        <div class="modal">
            <div class="modal-header">
                <h3>æäº¤è¯¦æƒ…</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="detailContent">
                <!-- è¯¦æƒ…å†…å®¹ -->
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeModal()">å…³é—­</button>
            </div>
        </div>
    </div>

    <script src="../js/auth.js"></script>
    <script>
        // æ£€æŸ¥ç™»å½•
        checkAuth();
        
        let submissions = [];
        let currentPage = 1;
        const pageSize = 10;
        
        // åˆå§‹åŒ–
        function init() {
            loadSubmissions();
        }
        
        // åŠ è½½æäº¤æ•°æ®
        function loadSubmissions() {
            const stored = localStorage.getItem('jiafu_submissions');
            if (stored) {
                submissions = JSON.parse(stored);
            } else {
                // æ¨¡æ‹Ÿä¸€äº›æ•°æ®
                submissions = [
                    {id: 1, itemName: 'æ¸…ä»£ç“·å™¨èŠ±ç“¶', itemCategory: 'antique', itemDesc: 'æ¸…ä»£æ™šæœŸé’èŠ±ç“·', contactName: 'å¼ ä¸‰', contactMobile: '13800138000', contactWechat: 'zhangsan', city: 'åŒ—äº¬', createdAt: '2026-02-17T10:30:00', handleStatus: 'pending'},
                    {id: 2, itemName: 'é½ç™½çŸ³ç”»ä½œ', itemCategory: 'art', itemDesc: 'åå®¶å­—ç”»', contactName: 'æå››', contactMobile: '13900139000', city: 'ä¸Šæµ·', createdAt: '2026-02-16T15:20:00', handleStatus: 'processed'},
                    {id: 3, itemName: 'ç¿¡ç¿ æ‰‹é•¯', itemCategory: 'jewelry', itemDesc: 'ç»ç’ƒç§ç¿¡ç¿ ', contactName: 'ç‹äº”', contactWechat: 'wangwu', city: 'å¹¿å·', createdAt: '2026-02-15T09:00:00', handleStatus: 'pending'}
                ];
                saveToStorage();
            }
            
            renderStats();
            renderTable();
        }
        
        // ä¿å­˜åˆ°localStorage
        function saveToStorage() {
            localStorage.setItem('jiafu_submissions', JSON.stringify(submissions));
        }
        
        // æ¸²æŸ“ç»Ÿè®¡
        function renderStats() {
            const today = new Date().toISOString().split('T')[0];
            
            document.getElementById('totalCount').textContent = submissions.length;
            document.getElementById('todayCount').textContent = submissions.filter(s => s.createdAt.startsWith(today)).length;
            document.getElementById('pendingCount').textContent = submissions.filter(s => s.handleStatus !== 'processed').length;
        }
        
        // æ¸²æŸ“è¡¨æ ¼
        function renderTable() {
            const category = document.getElementById('filterCategory').value;
            const keyword = document.getElementById('searchKeyword').value;
            
            let filtered = [...submissions];
            
            if (category) filtered = filtered.filter(s => s.itemCategory === category);
            if (keyword) {
                const kw = keyword.toLowerCase();
                filtered = filtered.filter(s => 
                    (s.itemName && s.itemName.toLowerCase().includes(kw)) ||
                    (s.contactName && s.contactName.toLowerCase().includes(kw))
                );
            }
            
            // æŒ‰æ—¶é—´æ’åº
            filtered.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            // åˆ†é¡µ
            const totalPages = Math.ceil(filtered.length / pageSize);
            const start = (currentPage - 1) * pageSize;
            const paged = filtered.slice(start, start + pageSize);
            
            const tbody = document.getElementById('submissionsTable');
            if (paged.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state">æš‚æ— æ•°æ®</td></tr>';
            } else {
                tbody.innerHTML = paged.map(s => `
                    <tr>
                        <td>${s.id}</td>
                        <td>${s.itemName || '-'}</td>
                        <td>${getCategoryName(s.itemCategory)}</td>
                        <td>${s.contactName || '-'}</td>
                        <td>${s.contactMobile || s.contactWechat || '-'}</td>
                        <td>${s.city || '-'}</td>
                        <td>${formatDate(s.createdAt)}</td>
                        <td class="actions">
                            <button class="btn-sm btn-view" onclick="viewDetail(${s.id})">æŸ¥çœ‹</button>
                            <button class="btn-sm btn-edit" onclick="markProcessed(${s.id})">æ ‡è®°å·²å¤„ç†</button>
                        </td>
                    </tr>
                `).join('');
            }
            
            renderPagination(totalPages);
        }
        
        // åˆ†é¡µ
        function renderPagination(totalPages) {
            const pagination = document.getElementById('pagination');
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }
            
            let html = `<button ${currentPage === 1 ? 'disabled' : ''} onclick="goPage(${currentPage - 1})">ä¸Šä¸€é¡µ</button>`;
            for (let i = 1; i <= totalPages; i++) {
                html += `<button class="${i === currentPage ? 'active' : ''}" onclick="goPage(${i})">${i}</button>`;
            }
            html += `<button ${currentPage === totalPages ? 'disabled' : ''} onclick="goPage(${currentPage + 1})">ä¸‹ä¸€é¡µ</button>`;
            pagination.innerHTML = html;
        }
        
        function goPage(page) {
            currentPage = page;
            renderTable();
        }
        
        // è¾…åŠ©å‡½æ•°
        function getCategoryName(category) {
            const names = {'art': 'è‰ºæœ¯å“', 'antique': 'å¤è‘£æ–‡ç‰©', 'jewelry': 'ç å®å¥¢ä¾ˆå“', 'coin': 'æ–‡çŒ®é‚®å¸', 'nft': 'æ•°å­—è—å“', 'misc': 'æ‚é¡¹'};
            return names[category] || category;
        }
        
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('zh-CN') + ' ' + date.toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit'});
        }
        
        // æŸ¥çœ‹è¯¦æƒ…
        function viewDetail(id) {
            const item = submissions.find(s => s.id === id);
            if (!item) return;
            
            document.getElementById('detailContent').innerHTML = `
                <div class="form-row">
                    <div class="form-group">
                        <label>è—å“åç§°</label>
                        <p>${item.itemName || '-'}</p>
                    </div>
                    <div class="form-group">
                        <label>å“ç±»</label>
                        <p>${getCategoryName(item.itemCategory)}</p>
                    </div>
                </div>
                <div class="form-group">
                    <label>è—å“æè¿°</label>
                    <p>${item.itemDesc || '-'}</p>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>è”ç³»äºº</label>
                        <p>${item.contactName || '-'}</p>
                    </div>
                    <div class="form-group">
                        <label>æ‰‹æœºå·</label>
                        <p>${item.contactMobile || '-'}</p>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>å¾®ä¿¡å·</label>
                        <p>${item.contactWechat || '-'}</p>
                    </div>
                    <div class="form-group">
                        <label>æ‰€åœ¨åŸå¸‚</label>
                        <p>${item.city || '-'}</p>
                    </div>
                </div>
                <div class="form-group">
                    <label>æäº¤æ—¶é—´</label>
                    <p>${formatDate(item.createdAt)}</p>
                </div>
                <div class="form-group">
                    <label>å¤„ç†çŠ¶æ€</label>
                    <p>${item.handleStatus === 'processed' ? 'âœ… å·²å¤„ç†' : 'â³ å¾…å¤„ç†'}</p>
                </div>
            `;
            
            document.getElementById('detailModal').classList.add('active');
        }
        
        // å…³é—­å¼¹çª—
        function closeModal() {
            document.getElementById('detailModal').classList.remove('active');
        }
        
        // æ ‡è®°å·²å¤„ç†
        function markProcessed(id) {
            if (confirm('ç¡®å®šè¦å°†æ­¤æäº¤æ ‡è®°ä¸ºå·²å¤„ç†å—ï¼Ÿ')) {
                const index = submissions.findIndex(s => s.id === id);
                if (index > -1) {
                    submissions[index].handleStatus = 'processed';
                    saveToStorage();
                    loadSubmissions();
                }
            }
        }
        
        // å¯¼å‡ºæ•°æ®
        function exportData() {
            let csv = 'ID,è—å“åç§°,å“ç±»,è”ç³»äºº,æ‰‹æœºå·,å¾®ä¿¡,åŸå¸‚,æäº¤æ—¶é—´,å¤„ç†çŠ¶æ€\n';
            submissions.forEach(s => {
                csv += `${s.id},"${s.itemName || ''}",${getCategoryName(s.itemCategory)},"${s.contactName || ''}","${s.contactMobile || ''}","${s.contactWechat || ''}","${s.city || ''}","${s.createdAt}","${s.handleStatus === 'processed' ? 'å·²å¤„ç†' : 'å¾…å¤„ç†'}"\n`;
            });
            
            const blob = new Blob(['\ufeff' + csv], {type: 'text/csv;charset=utf-8'});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `è—å“æäº¤è®°å½•_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }
        
        // ç›‘å¬ç­›é€‰
        document.getElementById('filterCategory').addEventListener('change', loadSubmissions);
        
        init();
    </script>
</body>
</html>
