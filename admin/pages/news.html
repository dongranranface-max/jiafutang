<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–°é—»ç®¡ç† - å˜‰å­šå ‚åå°ç®¡ç†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="../../css/style.css">
    <link rel="stylesheet" href="../css/admin.css">
</head>
<body>
    <div class="admin-wrapper">
        <!-- ä¾§è¾¹æ  -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <img src="../../images/logo.png" alt="å˜‰å­šå ‚">
                <h2>åå°ç®¡ç†</h2>
            </div>
            <nav class="sidebar-nav">
                <a href="../dashboard.html" class="nav-item">
                    <span>ğŸ“Š</span> <span>æ§åˆ¶å°</span>
                </a>
                <a href="collections.html" class="nav-item">
                    <span>ğŸ¨</span> <span>è—å“ç®¡ç†</span>
                </a>
                <a href="news.html" class="nav-item active">
                    <span>ğŸ“°</span> <span>æ–°é—»ç®¡ç†</span>
                </a>
                <a href="submissions.html" class="nav-item">
                    <span>ğŸ“‹</span> <span>æäº¤è®°å½•</span>
                </a>
                <a href="#" onclick="logout(); return false;" class="nav-item">
                    <span>ğŸšª</span> <span>é€€å‡ºç™»å½•</span>
                </a>
            </nav>
        </aside>

        <!-- ä¸»å†…å®¹ -->
        <main class="main-content">
            <div class="page-header">
                <h1>æ–°é—»ç®¡ç†</h1>
                <button class="btn-sm btn-view" onclick="openModal()">+ æ·»åŠ æ–°é—»</button>
            </div>

            <!-- ç­›é€‰ -->
            <div class="filter-bar">
                <select id="filterCategory" onchange="renderTable()">
                    <option value="">å…¨éƒ¨åˆ†ç±»</option>
                    <option value="brand">å˜‰å­šå ‚åŠ¨æ€</option>
                    <option value="industry">è¡Œä¸šåŠ¨æ€</option>
                </select>
                <input type="text" id="searchKeyword" placeholder="æœç´¢æ–°é—»..." oninput="renderTable()">
            </div>

            <!-- è¡¨æ ¼ -->
            <div class="table-wrapper">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ç¼–å·</th>
                            <th>æ ‡é¢˜</th>
                            <th>åˆ†ç±»</th>
                            <th>å‘å¸ƒæ—¶é—´</th>
                            <th>ç½®é¡¶</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="newsTable">
                    </tbody>
                </table>
            </div>

            <!-- åˆ†é¡µ -->
            <div class="pagination" id="pagination">
            </div>
        </main>
    </div>

    <!-- æ·»åŠ /ç¼–è¾‘å¼¹çª— -->
    <div class="modal-overlay" id="newsModal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modalTitle">æ·»åŠ æ–°é—»</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="newsForm">
                    <input type="hidden" id="newsId">
                    <div class="form-group">
                        <label>æ ‡é¢˜ *</label>
                        <input type="text" id="newsTitle" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>åˆ†ç±» *</label>
                            <select id="newsCategory" required>
                                <option value="">è¯·é€‰æ‹©</option>
                                <option value="brand">å˜‰å­šå ‚åŠ¨æ€</option>
                                <option value="industry">è¡Œä¸šåŠ¨æ€</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>é¦–é¡µç½®é¡¶</label>
                            <select id="newsTop">
                                <option value="false">å¦</option>
                                <option value="true">æ˜¯</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>å°é¢å›¾ç‰‡URL</label>
                        <input type="text" id="newsCoverImage" placeholder="https://...">
                    </div>
                    <div class="form-group">
                        <label>æ‘˜è¦</label>
                        <textarea id="newsSummary" placeholder="ç®€çŸ­æ‘˜è¦..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>æ­£æ–‡å†…å®¹ (HTML)</label>
                        <textarea id="newsContent" style="min-height: 150px;" placeholder="<p>æ­£æ–‡å†…å®¹...</p>"></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn-cancel" onclick="closeModal()">å–æ¶ˆ</button>
                        <button type="button" class="btn-save" onclick="saveNews()">ä¿å­˜</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="../js/auth.js"></script>
    <script>
        let newsList = [];
        let currentPage = 1;
        const pageSize = 10;
        
        // å­˜å‚¨é”®å
        const STORAGE_KEY = 'jiafu_news';
        
        // åˆå§‹åŒ–
        function init() {
            loadNews();
        }
        
        // åŠ è½½æ–°é—»æ•°æ® - ä¼˜å…ˆä»localStorage
        function loadNews() {
            const stored = localStorage.getItem(STORAGE_KEY);
            if (stored) {
                try {
                    newsList = JSON.parse(stored);
                } catch(e) {
                    newsList = getDefaultNews();
                }
            } else {
                newsList = getDefaultNews();
                saveToStorage();
            }
            renderTable();
        }
        
        // é»˜è®¤æ•°æ®
        function getDefaultNews() {
            return [
                {id:1,title:'2026å¹´æ˜¥å­£è‰ºæœ¯å“æ‹å–ä¼šåœ†æ»¡è½å¹•',category:'brand',coverImage:'https://images.unsplash.com/photo-1518998053901-5348d3961a04?w=600',summary:'æˆäº¤æ€»é¢çªç ´5äº¿å…ƒ',isTop:true,sort:1},
                {id:2,title:'æ”¶è—å¸‚åœºæŒç»­å‡æ¸©',category:'industry',coverImage:'https://images.unsplash.com/photo-1578926288207-a90a5366759d?w=600',summary:'å¸‚åœºæŒç»­å‡æ¸©',isTop:false,sort:2},
                {id:3,title:'å˜‰å­šå ‚å¼€é€šçº¿ä¸Šè—å“å¾é›†æœåŠ¡',category:'brand',coverImage:'https://images.unsplash.com/photo-1621155346337-1d19476ba7d6?w=600',summary:'å¼€é€šæœåŠ¡',isTop:false,sort:3}
            ];
        }
        
        // ä¿å­˜åˆ°localStorage
        function saveToStorage() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(newsList));
        }
        
        // æ¸²æŸ“è¡¨æ ¼
        function renderTable() {
            const category = document.getElementById('filterCategory').value;
            const keyword = document.getElementById('searchKeyword').value;
            
            let filtered = [...newsList];
            
            if (category) filtered = filtered.filter(n => n.category === category);
            if (keyword) filtered = filtered.filter(n => n.title.includes(keyword) || n.summary.includes(keyword));
            
            filtered.sort((a, b) => b.sort - a.sort);
            
            const totalPages = Math.ceil(filtered.length / pageSize);
            const start = (currentPage - 1) * pageSize;
            const paged = filtered.slice(start, start + pageSize);
            
            const tbody = document.getElementById('newsTable');
            if (paged.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="empty-state">æš‚æ— æ•°æ®</td></tr>';
            } else {
                tbody.innerHTML = paged.map(n => `
                    <tr>
                        <td>${n.sort}</td>
                        <td>${n.title}</td>
                        <td>${n.category === 'brand' ? 'å˜‰å­šå ‚åŠ¨æ€' : 'è¡Œä¸šåŠ¨æ€'}</td>
                        <td>${new Date().toLocaleDateString()}</td>
                        <td>${n.isTop ? 'âœ…' : 'âŒ'}</td>
                        <td>
                            <button class="btn-sm" onclick="editNews(${n.id})">ç¼–è¾‘</button>
                            <button class="btn-sm btn-danger" onclick="deleteNews(${n.id})">åˆ é™¤</button>
                        </td>
                    </tr>
                `).join('');
            }
            
            // åˆ†é¡µ
            const pagination = document.getElementById('pagination');
            if (totalPages > 1) {
                let html = '';
                for (let i = 1; i <= totalPages; i++) {
                    html += `<button class="${i === currentPage ? 'active' : ''}" onclick="goPage(${i})">${i}</button>`;
                }
                pagination.innerHTML = html;
            } else {
                pagination.innerHTML = '';
            }
        }
        
        function goPage(page) {
            currentPage = page;
            renderTable();
        }
        
        // æ‰“å¼€å¼¹çª—
        function openModal(id = null) {
            const modal = document.getElementById('newsModal');
            const title = document.getElementById('modalTitle');
            
            if (id) {
                const item = newsList.find(n => n.id === id);
                if (item) {
                    title.textContent = 'ç¼–è¾‘æ–°é—»';
                    document.getElementById('newsId').value = item.id;
                    document.getElementById('newsTitle').value = item.title;
                    document.getElementById('newsCategory').value = item.category;
                    document.getElementById('newsTop').value = item.isTop ? 'true' : 'false';
                    document.getElementById('newsCoverImage').value = item.coverImage || '';
                    document.getElementById('newsSummary').value = item.summary || '';
                    document.getElementById('newsContent').value = item.content || '';
                }
            } else {
                title.textContent = 'æ·»åŠ æ–°é—»';
                document.getElementById('newsForm').reset();
                document.getElementById('newsId').value = '';
            }
            
            modal.classList.add('active');
        }
        
        function closeModal() {
            document.getElementById('newsModal').classList.remove('active');
        }
        
        // ä¿å­˜æ–°é—»
        function saveNews() {
            const id = document.getElementById('newsId').value;
            const data = {
                title: document.getElementById('newsTitle').value,
                category: document.getElementById('newsCategory').value,
                isTop: document.getElementById('newsTop').value === 'true',
                coverImage: document.getElementById('newsCoverImage').value,
                summary: document.getElementById('newsSummary').value,
                content: document.getElementById('newsContent').value
            };
            
            if (!data.title || !data.category) {
                alert('è¯·å¡«å†™å¿…å¡«é¡¹');
                return;
            }
            
            if (id) {
                const index = newsList.findIndex(n => n.id === parseInt(id));
                newsList[index] = { ...newsList[index], ...data };
            } else {
                const newId = newsList.length > 0 ? Math.max(...newsList.map(n => n.id)) + 1 : 1;
                newsList.push({ id: newId, sort: newId, ...data });
            }
            
            saveToStorage();
            closeModal();
            renderTable();
            alert('ä¿å­˜æˆåŠŸï¼');
        }
        
        // ç¼–è¾‘æ–°é—»
        function editNews(id) {
            openModal(id);
        }
        
        // åˆ é™¤æ–°é—»
        function deleteNews(id) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡æ–°é—»å—ï¼Ÿ')) {
                newsList = newsList.filter(n => n.id !== id);
                saveToStorage();
                renderTable();
            }
        }
        
        // åˆå§‹åŒ–
        init();
    </script>
</body>
</html>
